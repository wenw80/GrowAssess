// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("user") // user, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tests     Test[]

  @@index([email])
}

model Test {
  id              String           @id @default(uuid())
  title           String
  description     String?
  category        String?
  durationMinutes Int?
  userId          String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  questions       Question[]
  assignments     TestAssignment[]

  @@index([userId])
}

model Question {
  id               String     @id @default(uuid())
  testId           String
  type             String     // mcq, freetext, timed
  content          String
  options          String?    // JSON string for MCQ options
  correctAnswer    String?
  timeLimitSeconds Int?
  points           Int        @default(1)
  order            Int
  test             Test       @relation(fields: [testId], references: [id], onDelete: Cascade)
  responses        Response[]

  @@index([testId])
}

model Candidate {
  id          String           @id @default(uuid())
  name        String
  email       String
  phone       String?
  position    String?
  status      String           @default("active") // active, hired, rejected, pending
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  assignments TestAssignment[]

  @@index([email])
}

model TestAssignment {
  id          String     @id @default(uuid())
  candidateId String
  testId      String
  uniqueLink  String     @unique
  status      String     @default("not_started") // not_started, in_progress, completed
  assignedAt  DateTime   @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  candidate   Candidate  @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  test        Test       @relation(fields: [testId], references: [id], onDelete: Cascade)
  responses   Response[]

  @@index([candidateId])
  @@index([testId])
  @@index([uniqueLink])
}

model Response {
  id               String         @id @default(uuid())
  assignmentId     String
  questionId       String
  answer           String?
  isCorrect        Boolean?
  score            Int?
  timeTakenSeconds Int?
  graderNotes      String?
  createdAt        DateTime       @default(now())
  assignment       TestAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  question         Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, questionId])
  @@index([assignmentId])
  @@index([questionId])
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
}
